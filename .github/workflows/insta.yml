# .github/workflows/post_events_image.yml
# L√§dt Events-Bild ins Repo und postet es auf Instagram.
# Nutzt dein **PAT_TOKEN** statt des automatisch erzeugten GITHUB_TOKEN.

name: Post events image

on:
  workflow_dispatch:                # manueller Button
  schedule:
    - cron: "0 6 * * *"             # 06 UTC = 08 Uhr Berlin (Sommerzeit)

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      # 1) Repository auschecken
      - uses: actions/checkout@v4

      # 2) Python 3.11 installieren
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) Debug: Welches Python & Pip?
      - name: Debug Python & Pip
        run: |
          echo "Python executable: $(which python)"
          python --version
          echo "Pip executable: $(which pip)"
          pip --version

      # 4) System-Abh√§ngigkeiten installieren (ffmpeg f√ºr MoviePy)
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # 5) Python-Abh√§ngigkeiten (mit python -m pip)
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install Pillow requests pytz matplotlib moviepy

      # 6) Debug: site-packages & Import-Test
      - name: Debug site-packages & imports
        run: |
          python - << 'EOF'
import sys, os, glob
from distutils.sysconfig import get_python_lib
import pkg_resources

print("Python executable:", sys.executable)
print("sys.path:")
for p in sys.path:
    print("  ", p)
site = get_python_lib()
print("site-packages dir:", site)
print("moviepy-Ordner(en):", glob.glob(os.path.join(site, "moviepy*")))

print("\nInstalled packages containing 'moviepy':")
for p in pkg_resources.working_set:
    if "moviepy" in p.project_name.lower():
        print(" ", p)

print("\nTrying imports‚Ä¶")
try:
    import moviepy
    print("‚úÖ import moviepy OK, version:", moviepy.__version__)
except Exception as e:
    print("‚ùå import moviepy failed:", e)

try:
    from moviepy.editor import VideoFileClip
    print("‚úÖ import moviepy.editor OK")
except Exception as e:
    print("‚ùå import moviepy.editor failed:", e)
EOF

      # 7) Debug-Step ‚Äì pr√ºft, ob alle Variablen gesetzt sind
      - name: Debug env variables
        env:
          GITHUB_TOKEN:    ${{ secrets.PAT_TOKEN }}        # dein PAT
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}  # bereits angelegt
          IG_USER_ID:      ${{ secrets.IG_USER_ID }}       # bereits angelegt
        run: |
          echo "üîé Pr√ºfe erforderliche ENV-Variablen:"
          for V in GITHUB_TOKEN GITHUB_REPOSITORY IG_ACCESS_TOKEN IG_USER_ID; do
            [ -n "${!V}" ] && echo "$V = ‚úÖ gesetzt" || echo "$V = ‚ùå fehlt!"
          done

      # 8) Bild generieren, ins Repo laden & auf Instagram posten
      - name: Generate, upload & post image
        env:
          GITHUB_TOKEN:    ${{ secrets.PAT_TOKEN }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID:      ${{ secrets.IG_USER_ID }}
        run: python insta.py
